{% extends "base.html" %}

{% block title %}–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ ‚Äî TrustVote{% endblock %}

{% block content %}
<div class="form-box">
    <h2>‚úÖ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="success-card">
        <h3>üéâ –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!</h3>
        <p><strong>–ö–æ–¥ —Å–µ—Å—Å–∏–∏:</strong> <code>{{ session_id }}</code></p>

        <div class="instruction-box">
            <h4>üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</h4>
            <ol>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –≤—ã—à–µ</li>
                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ:
                    <code>{{ request.url_root }}vote/{{ session_id }}</code>
                </li>
                <li>–ò–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∏–∂–µ üëá</li>
            </ol>
        </div>

        <!-- QR-–∫–æ–¥ (–ø–æ —Ü–µ–Ω—Ç—Ä—É) -->
        <div id="qrContainer" style="display: none; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px;">
            <h4>üì± –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥</h4>
            <div id="qrcode" style="margin: 0 auto; display: inline-block;"></div>
            <p style="font-size: 0.9rem; color: #636e72; margin-top: 10px;">
                –°—Å—ã–ª–∫–∞: <br>
                <code id="qrUrl" style="word-break: break-all; cursor: pointer;"></code>
            </p>
        </div>
    </div>

    <a href="{{ url_for('index') }}" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
</div>

<style>
.success-card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.instruction-box {
    background: #e9f5ff;
    padding: 15px;
    border-radius: 12px;
    margin: 20px 0;
    font-size: 0.95rem;
}
.instruction-box ol {
    padding-left: 20px;
}
.instruction-box code {
    background: #d0eaff;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
}
#qrUrl {
    background: #e0e0ff;
    padding: 2px 6px;
    border-radius: 4px;
}
</style>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É QR-–∫–æ–¥–∞ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ QR-–∫–æ–¥–∞
function generateQRCode(sessionId) {
    if (!sessionId) return;

    const baseUrl = window.location.origin;
    const voteUrl = `${baseUrl}/vote/${sessionId}`;

    // 1. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç—ã
    const qrUrlEl = document.getElementById('qrUrl');
    const qrContainer = document.getElementById('qrcode');

    // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏
    if (qrUrlEl) {
        qrUrlEl.textContent = voteUrl;
    }

    // 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, {
        text: voteUrl,
        width: 200,
        height: 200,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
    });

    // 4. –¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º —Å—Å—ã–ª–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
    if (qrUrlEl) {
        qrUrlEl.onclick = () => {
            navigator.clipboard.writeText(voteUrl).then(() => {
                const original = qrUrlEl.textContent;
                qrUrlEl.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    qrUrlEl.textContent = original;
                }, 1500);
            }).catch(() => {
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
            });
        };
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
    document.getElementById('qrContainer').style.display = 'block';
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    const sessionId = "{{ session_id }}";
    if (sessionId) {
        generateQRCode(sessionId);
    }
});
</script>
{% endblock %}